# ランダム席替えアプリ 技術設計書（change-seats-app）

教員向け。出席番号ベースで個人を特定し、視力・「近くにしない」制約を満たしつつ、**前回と完全同一の席にしない** ランダム席替えを行う。

---

## 1. アプリ概要

| 項目 | 内容 |
|------|------|
| 対象 | 教員（1 アカウント＝1 クラス運用を想定） |
| 個人情報 | 出席番号のみ登録。氏名は保存しない想定 |
| DB | SQLite（情報保持のため） |
| 認証 | トップでログイン、会員登録あり |

---

## 2. 画面構成

| 画面 | パス例 | 概要 |
|------|--------|------|
| トップ（ログイン） | `/` | ログインフォーム。未認証時はここへ |
| 会員登録 | `/register` | 教員アカウント登録 |
| メイン画面 | `/home` または `/dashboard` | 現在の席表表示・席替え実行・再シャッフル・保存・印刷 |
| 設定画面 | `/settings` | クラス人数・座席数/配置・現在の席・クラスメイト（出席番号・特性）の登録 |

---

## 3. 機能要件（整理）

### 3.1 認証

- 教員の会員登録（メール or ユーザー名 + パスワード）
- ログイン / ログアウト
- 未ログイン時はトップ（ログイン）へリダイレクト

### 3.2 設定画面

- **クラスメイト人数** の設定
- **座席の数・配置** の設定  
  - 例: 縦×横（5×6）、または座席マスを手動配置
- **現在の席** の登録  
  - 出席番号 ↔ 席位置の対応を登録（席替え前の状態）
- **クラスメイト情報**（出席番号単位）
  - 出席番号（1〜N）
  - **近くにしない**：別の出席番号を複数指定可能（相互でなくても可）
  - **視力**
    - なし / 軽度 / 重度  
    - 重度 → 最前列からランダムに割り当て  
    - 軽度 → その次に前列を優先してランダムに割り当て

### 3.3 席替えロジック（メイン画面）

- **ランダム席替え実行**
  - 制約:
    1. 視力・重度: 最前列からランダムに配置
    2. 視力・軽度: 残りで前列優先してランダムに配置
    3. 上記以外: 残りの席をランダムに配置
    4. **「近くにしない」**: 指定ペアが隣接・前後隣にならないようにする（隣の定義は設計で固定: 上下左右 or 斜め含むか）
    5. **絶対禁止**: 現在の席と **完全に同じ** 配置にしない（少なくとも 1 人以上必ず動く）
- **再シャッフル**: 納得いかない場合、再度ランダム席替えを実行（上記制約＋「前回と同一でない」は、その都度「直前の結果」と比較）
- **保存**: 確定した席配置を DB に保存し、「現在の席」として次回の席替えの「前回」になる
- **印刷**: 確定した席表を印刷用に表示（出席番号のみ。紙で印刷想定）

### 3.4 追加で持たせるとよい機能

- **複数クラス対応**（任意）: 1 ユーザーで複数クラスを持てるようにする（クラス名・クラス切り替え）
- **席配置プリセット**: よく使う縦×横を保存して選択
- **印刷用レイアウト**: A4 縦/横、フォントサイズなど（後からでも可）

---

## 4. DB 設計（SQLite）

### 4.1 テーブル概要

| テーブル | 役割 |
|---------|------|
| users | 教員アカウント（Laravel 標準の users を流用） |
| classes | クラス（1 ユーザー 1 クラスなら省略可。複数クラス対応時用） |
| seat_layouts | 座席レイアウト（縦・横、または座席マス定義） |
| classmates | クラスメイト（出席番号・視力・「近くにしない」など） |
| seat_constraints | 「近くにしない」ペア（classmate_id 同士 or 出席番号 2 つ） |
| current_seats | 現在の席（出席番号 ↔ 席位置） |
| seat_history | 保存した席表の履歴（印刷・参照用）（任意） |

### 4.2 主要カラム案

- **users**  
  - id, name, email, password, timestamps（Laravel 標準）

- **classes**（複数クラス対応時）  
  - id, user_id, name, created_at, updated_at

- **seat_layouts**  
  - id, user_id（または class_id）, name, rows, cols, または json で座席グリッド定義

- **classmates**  
  - id, user_id（または class_id）, number（出席番号）, vision_grade（none/mild/severe）, created_at, updated_at

- **seat_constraints**（近くにしない）  
  - id, user_id, classmate_id_a, classmate_id_b（または number_a, number_b）

- **current_seats**  
  - id, user_id（または class_id）, classmate_id（または number）, row, col, または position_index

- **seat_history**（任意）  
  - id, user_id, snapshot（json で席配置）, saved_at

※ まずは 1 ユーザー 1 クラスで進めると実装が簡単。複数クラスは後から class_id を足す形で拡張可能。

---

## 5. 席替えアルゴリズム（概要）

1. **席の順序を定義**  
   - 最前列: row=0 の席をリスト化  
   - 軽度用: 2 列目など「前列」を定義しリスト化  
   - その他: 残り

2. **割り当て**  
   - 重度 → 最前列リストをシャッフルし、順に割り当て  
   - 軽度 → 前列リストの残りをシャッフルし、順に割り当て  
   - その他 → 残り席をシャッフルし、順に割り当て

3. **「近くにしない」**  
   - 割り当て候補を出したあと、隣接チェック。違反していたら該当者だけ再シャッフルして再割り当て（または全体をやり直し）し、違反がなくなるまで繰り返す

4. **前回と同一でない保証**  
   - 現在の席（current_seats）と比較し、全て同じならやり直し。少なくとも 1 人以上違う配置になるまでシャッフルを繰り返す（上限回数で打ち切り＋エラー表示の fallback を用意）

5. **再シャッフル**  
   - 画面に表示している「今回の結果」を「前回」として 4 を満たすように再度実行

---

## 6. 技術スタック・ディレクトリ方針

- **PHP 8.2 / Laravel 12**
- **SQLite**（開発・本番とも DB は SQLite）
- **認証**: Laravel Breeze または Fortify + Blade（シンプルに）
- **フロント**: Blade + 必要に応じて Alpine.js または Vue（席表のインタラクション用）
- **印刷**: ブラウザの印刷機能（CSS `@media print`）で出席番号の席表を表示

---

## 7. 非機能・セキュリティ

- 個人情報は出席番号のみ保存。氏名は保存しない設計で運用
- 教員アカウントは登録・ログインのみ（招待制にするかは別要件）
- SQLite ファイルの配置・パーミッションはサーバー設定で保護

---

## 8. 今後の拡張候補

- 複数クラス対応（class_id 導入）
- 席配置のプリセット保存
- 印刷レイアウトのカスタム（用紙・フォント）
- 履歴一覧から過去の席表を参照・再印刷
